<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

<meta property="og:title" content="Using Callbacks" />
  
<meta property="og:type" content="website" />
  
<meta property="og:url" content="https://finetuner.jina.ai/walkthrough/using-callbacks/" />
  
<meta property="og:site_name" content="Finetuner Documentation" />
  
<meta property="og:description" content="Callbacks are a way of adding additional methods to the finetuning process. The methods are executed when certain events occur and there are several callback classes, each serving a different function by providing different methods for different events. A run can be assigned multiple callbacks us..." />
  
<meta property="og:image" content="https://finetuner.jina.ai/_static/banner.png" />
  
<meta property="og:image:alt" content="Finetuner Documentation" />
  
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@JinaAI_">
<meta name="twitter:creator" content="@JinaAI_">
<meta name="description" content="Finetuner is a library for tune the weights of any deep neural network for better embeddings on search tasks.">
<meta property="og:description" content="Finetuner allows one to tune the weights of any deep neural network for better embeddings on search tasks. It accompanies Jina to deliver the last mile of performance for domain-specific neural search applications.">

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1ESRNDCK35"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1ESRNDCK35');
</script>

<script async defer src="https://buttons.github.io/buttons.js"></script>
    <link rel="index" title="Index" href="../../genindex/" /><link rel="search" title="Search" href="../../search/" /><link rel="next" title="Encode Documents" href="../integrate-with-jina/" /><link rel="prev" title="Save Artifact" href="../save-model/" />
        <link rel="canonical" href="https://finetuner.jina.ai/walkthrough/using-callbacks.html" />

    <link rel="shortcut icon" href="../../_static/favicon.png"/><meta name="generator" content="sphinx-4.5.0, furo 2022.09.29"/>
        <title>Using Callbacks - Finetuner documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=d81277517bee4d6b0349d71bb2661d4890b5617c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: #4d4d4d;
  --color-brand-primary: #009191;
  --color-brand-content: #009191;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FBCB67;
  --color-brand-content: #FBCB67;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FBCB67;
  --color-brand-content: #FBCB67;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
    <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
    <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
    <header class="mobile-header">
        <div class="header-left">
            <label class="nav-overlay-icon" for="__navigation">
                <div class="visually-hidden">Toggle site navigation sidebar</div>
                <i class="icon">
                    <svg>
                        <use href="#svg-menu"></use>
                    </svg>
                </i>
            </label>
        </div>
        <div class="header-center">
            <a href="../../">
                <div class="brand">Finetuner  documentation</div>
            </a>
        </div>
        <div class="header-right">
            <div class="theme-toggle-container theme-toggle-header">
                <button class="theme-toggle">
                    <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
                    <svg class="theme-icon-when-auto">
                        <use href="#svg-sun-half"></use>
                    </svg>
                    <svg class="theme-icon-when-dark">
                        <use href="#svg-moon"></use>
                    </svg>
                    <svg class="theme-icon-when-light">
                        <use href="#svg-sun"></use>
                    </svg>
                </button>
            </div>
            <label class="toc-overlay-icon toc-header-icon" for="__toc">
                <div class="visually-hidden">Toggle table of contents sidebar</div>
                <i class="icon">
                    <svg>
                        <use href="#svg-toc"></use>
                    </svg>
                </i>
            </label>
        </div>
    </header>
    <aside class="sidebar-drawer">
        <div class="sidebar-container">
            
            <div class="sidebar-sticky"><a class="sidebar-brand" href="../../">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/logo-light.svg" alt="Light Logo" />
    <img class="sidebar-logo only-dark" src="../../_static/logo-dark.svg" alt="Dark Logo" />
  </div>
  
  
</a>
<div class="sd-d-flex-row sd-align-major-spaced">
  <a class="github-button" href="https://github.com/jina-ai/finetuner" data-icon="octicon-star" data-show-count="true" aria-label="Star jina-ai/jina on GitHub" style="opacity: 0;">Star</a>
  
</div><form class="sidebar-search-container" method="get" action="../../search/" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
    <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../get-started/how-it-works/">How Does it Work?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/design-principles/">Design Principles</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../">Walkthrough</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../basic-concepts/">Basic Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../login/">Login</a></li>
<li class="toctree-l2"><a class="reference internal" href="../create-training-data/">Prepare Training Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../choose-backbone/">Backbone Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../run-job/">Run Job</a></li>
<li class="toctree-l2"><a class="reference internal" href="../save-model/">Save Artifact</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Using Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrate-with-jina/">Encode Documents</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finetuning Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tasks/text-to-text/">Text-to-Text Search via BERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tasks/image-to-image/">Image-to-Image Search via ResNet50</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tasks/text-to-image/">Text-to-Image Search via CLIP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/finetuner/">finetuner package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/finetuner.client/">finetuner.client package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/finetuner.client.client/">finetuner.client.client module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/finetuner.client.session/">finetuner.client.session module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.callback/">finetuner.callback module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.console/">finetuner.console module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.exception/">finetuner.exception module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.experiment/">finetuner.experiment module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.finetuner/">finetuner.finetuner module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.model/">finetuner.model module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.run/">finetuner.run module</a></li>
</ul>
</li>
</ul>

    <p class="caption" role="heading"><span class="caption-text">Ecosystem</span></p>
    <ul>
        <li class="toctree-l1">
            <a class="reference external" href="https://docs.jina.ai">
                <img class="sidebar-ecosys-logo only-light-line" src="../../_static/search-light.svg">
                <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/search-dark.svg">
                Jina</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://hub.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/hub-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/hub-dark.svg">
            Jina Hub</a></li>
        <li class="toctree-l1"><a class="reference internal" href="#">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/finetuner-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/finetuner-dark.svg">
            Finetuner</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://docarray.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/docarray-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/docarray-dark.svg">
            DocArray</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://clip-as-service.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/cas-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/cas-dark.svg">
            CLIP-as-service</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://github.com/jina-ai/jcloud">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/JCloud-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/JCloud-dark.svg">
            JCloud</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://github.com/jina-ai/now">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/now-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/now-dark.svg">
            NOW</a></li>
    </ul>
</div>
</div>

            </div>
            
        </div>
    </aside>
    <div class="main">
        <div class="content">
            <div class="article-container">
                <a href="#" class="back-to-top muted-link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
                    </svg>
                    <span>Back to top</span>
                </a>
                <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
                        <button class="theme-toggle">
                            <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
                            <svg class="theme-icon-when-auto">
                                <use href="#svg-sun-half"></use>
                            </svg>
                            <svg class="theme-icon-when-dark">
                                <use href="#svg-moon"></use>
                            </svg>
                            <svg class="theme-icon-when-light">
                                <use href="#svg-sun"></use>
                            </svg>
                        </button>
                    </div>
                    <label class="toc-overlay-icon toc-content-icon"
                           for="__toc">
                        <div class="visually-hidden">Toggle table of contents sidebar</div>
                        <i class="icon">
                            <svg>
                                <use href="#svg-toc"></use>
                            </svg>
                        </i>
                    </label>
                </div>
                <article role="main">
                    <section class="tex2jax_ignore mathjax_ignore" id="using-callbacks">
<span id="id1"></span><h1>Using Callbacks<a class="headerlink" href="#using-callbacks" title="Permalink to this headline">#</a></h1>
<p>Callbacks are a way of adding additional methods to the finetuning process. The methods are executed when certain events occur and there are several callback classes, each serving a different function by providing different methods for different events.
A run can be assigned multiple callbacks using the optional <code class="docutils literal notranslate"><span class="pre">callbacks</span></code> parameter when it is created.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">run</span> <span class="o">=</span> <span class="n">finetuner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;resnet50&#39;</span><span class="p">,</span>
    <span class="n">run_name</span> <span class="o">=</span> <span class="s1">&#39;resnet-tll-early-6&#39;</span><span class="p">,</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="s1">&#39;tll-train-da&#39;</span><span class="p">,</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
        <span class="n">EvaluationCallback</span><span class="p">(</span>
            <span class="n">query_data</span><span class="o">=</span><span class="s1">&#39;tll-test-query-da&#39;</span><span class="p">,</span>
            <span class="n">index_data</span><span class="o">=</span><span class="s1">&#39;tll-test-index-da&#39;</span>
        <span class="p">),</span>
        <span class="n">EarlyStopping</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<section id="evaluationcallback">
<h2>EvaluationCallback<a class="headerlink" href="#evaluationcallback" title="Permalink to this headline">#</a></h2>
<p>The evaluation callback is used to calculate performance metrics for the model being tuned at the end of each epoch. In order to evaluate the model, two additional data sets - a query dataset and an index dataset - need to be provided as arguments. If no index set is provided, the query dataset is reused instead. Below is an example of the metrics as they are output at the end of finetuning:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>  Training <span class="o">[</span><span class="m">5</span>/5<span class="o">]</span> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class="m">76</span>/76 <span class="m">0</span>:00:00 <span class="m">0</span>:00:16 • loss: <span class="m">0</span>.003
<span class="o">[</span><span class="m">14</span>:10:40<span class="o">]</span> INFO     Done ✨                                                                              __main__.py:194
           DEBUG    Finetuning took <span class="m">0</span> days, <span class="m">0</span> hours <span class="m">3</span> minutes and <span class="m">38</span> seconds                             __main__.py:196
           DEBUG    Metric: <span class="s1">&#39;resnet50_average_precision&#39;</span> Value: <span class="m">0</span>.16654                                  __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_dcg_at_k&#39;</span> Value: <span class="m">0</span>.24018                                           __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_f1_score_at_k&#39;</span> Value: <span class="m">0</span>.03631                                      __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_hit_at_k&#39;</span> Value: <span class="m">0</span>.38123                                           __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_ndcg_at_k&#39;</span> Value: <span class="m">0</span>.24018                                          __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_precision_at_k&#39;</span> Value: <span class="m">0</span>.01906                                     __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_r_precision&#39;</span> Value: <span class="m">0</span>.16654                                        __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_recall_at_k&#39;</span> Value: <span class="m">0</span>.38123                                        __main__.py:205
           DEBUG    Metric: <span class="s1">&#39;resnet50_reciprocal_rank&#39;</span> Value: <span class="m">0</span>.16654                                    __main__.py:205
           INFO     Building the artifact ...                                                            __main__.py:207
           INFO     Pushing artifact to Hubble ...                                                       __main__.py:231
</pre></div>
</div>
<p>The evaluation callback is triggered at the end of each epoch, in which the model is evaluated using the <code class="docutils literal notranslate"><span class="pre">query_data</span></code> and <code class="docutils literal notranslate"><span class="pre">index_data</span></code> datasets that were provided when the callback was created.
It is worth noting that the evaluation callback and the <code class="docutils literal notranslate"><span class="pre">eval_data</span></code> parameter of the fit method do not do the same thing. The eval data parameter takes a <code class="docutils literal notranslate"><span class="pre">DocumentArray</span></code> (or the name of one that has been pushed on the cloud) and uses its contents to evaluate the loss of the model whereas the evaluation callback is used to evaluate the quality of the searches using metrics such as average precision and recall. These search metrics can be used by other callbacks if the evaluation callback is first in the list of callbacks when creating a run.</p>
</section>
<section id="bestmodelcheckpoint">
<h2>BestModelCheckpoint<a class="headerlink" href="#bestmodelcheckpoint" title="Permalink to this headline">#</a></h2>
<p>This callback evaluates the performance of the model at the end of each epoch, and keeps a record of the best perfoming model across all epochs. Once fitting is finished the best performing model is saved instead of the most recent model. The definition of best is based on two parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">monitor</span></code>: The metric that is used to compare models to each other. By default this value is <code class="docutils literal notranslate"><span class="pre">val_loss</span></code>, the loss function calculated using the evaluation data, however the loss calculated on the training data can be used instead with <code class="docutils literal notranslate"><span class="pre">train_loss</span></code>; any metric that is recorded by the evaluation callback can also be used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code>: Whether the monitored metric should be maximised (<code class="docutils literal notranslate"><span class="pre">max</span></code>) or minimised (<code class="docutils literal notranslate"><span class="pre">min</span></code>). By default the mode is set to <code class="docutils literal notranslate"><span class="pre">auto</span></code>, meaning that it will automatically choose the correct mode depending on the chosen metric: ‘min’ if the metric is loss and ‘max’ if the metric is one recorded by the evaluation callback.</p></li>
</ul>
<p>The console output below shows how the evaluation loss of the model is monitored between each epoch, and how the best performing model is tracked. Since the final model has a higher loss than the previously recorded best model, the best model will be saved instead of the latest one.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>           INFO     Finetuning ...                                                   
                    __main__.py:173
<span class="o">[</span><span class="m">11</span>:50:33<span class="o">]</span> INFO     Model improved from inf to <span class="m">2</span>.756!                                
       best_model_checkpoint.py:112
<span class="o">[</span><span class="m">11</span>:50:52<span class="o">]</span> INFO     Model improved from <span class="m">2</span>.756 to <span class="m">2</span>.711!                              
       best_model_checkpoint.py:112
<span class="o">[</span><span class="m">11</span>:51:10<span class="o">]</span> INFO     Model did not improve                                            
       best_model_checkpoint.py:120
<span class="o">[</span><span class="m">11</span>:51:28<span class="o">]</span> INFO     Model did not improve                                            
       best_model_checkpoint.py:120
  Training <span class="o">[</span><span class="m">4</span>/4<span class="o">]</span> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class="m">54</span>/54 <span class="m">0</span>:00:00 <span class="m">0</span>:00:15 • loss: <span class="m">0</span>.496 • val_loss: <span class="m">2</span>.797
           INFO     Done ✨                                                          
                    __main__.py:194
           DEBUG    Finetuning took <span class="m">0</span> days, <span class="m">0</span> hours <span class="m">1</span> minutes and <span class="m">16</span> seconds         
                    __main__.py:196
           INFO     Building the artifact ...                                        
                    __main__.py:207
           INFO     Pushing artifact to Hubble ...                                   
                    __main__.py:231
</pre></div>
</div>
</section>
<section id="earlystopping">
<h2>EarlyStopping<a class="headerlink" href="#earlystopping" title="Permalink to this headline">#</a></h2>
<p>Similarly to the best model checkpoint callback, the early stopping callback measures a given metric at the end of every epoch. Unlike the best model checkpoint callback, the early stopping callback does not save the best model; only the monitored metric is recorded between runs in order to assess the rate of improvement.</p>
<p>Below is some example output for a run with the early stopping callback followed by the output for the same run without the early stopping callback, and then the python code used to create the run. The output for the run with early stopping finished after just ten epochs whereas the other run finished all twenty epochs, resulting in nearly twice the runtime. That said, the resulting loss value of the early stopping run is only 0.284, compared to the full run’s 0.272, less than five percent higher. The early stopping callback can be used in this way to reduce the amount of training time while still showing improvement.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>  Training <span class="o">[</span><span class="m">10</span>/20<span class="o">]</span> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class="m">54</span>/54 <span class="m">0</span>:00:00 <span class="m">0</span>:00:14 • loss: <span class="m">0</span>.284
<span class="o">[</span><span class="m">11</span>:19:28<span class="o">]</span> INFO     Done ✨                                                                              __main__.py:194
           DEBUG    Finetuning took <span class="m">0</span> days, <span class="m">0</span> hours <span class="m">2</span> minutes and <span class="m">30</span> seconds                             __main__.py:196
           INFO     Building the artifact ...                                                            __main__.py:207
           INFO     Pushing artifact to Hubble ...                                                       __main__.py:231
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>  Training <span class="o">[</span><span class="m">20</span>/20<span class="o">]</span> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class="m">54</span>/54 <span class="m">0</span>:00:00 <span class="m">0</span>:00:14 • loss: <span class="m">0</span>.272
<span class="o">[</span><span class="m">10</span>:37:33<span class="o">]</span> INFO     Done ✨                                                                              __main__.py:194
           DEBUG    Finetuning took <span class="m">0</span> days, <span class="m">0</span> hours <span class="m">4</span> minutes and <span class="m">54</span> seconds                             __main__.py:196
           INFO     Building the artifact ...                                                            __main__.py:207
           INFO     Pushing artifact to Hubble ...                                                       __main__.py:231
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">finetuner.callback</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">EvaluationCallback</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">finetuner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;openai/clip-vit-base-patch32&#39;</span><span class="p">,</span>
    <span class="n">run_name</span><span class="o">=</span><span class="s1">&#39;clip-fashion-early&#39;</span><span class="p">,</span>
    <span class="n">train_data</span><span class="o">=</span><span class="s1">&#39;clip-fashion-train-data&#39;</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;CLIPLoss&#39;</span><span class="p">,</span>
    <span class="n">cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span> <span class="p">[</span>
        <span class="n">callback</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="s2">&quot;train_loss&quot;</span><span class="p">,</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">min_delta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">baseline</span><span class="o">=</span><span class="mf">1.5</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The early stopping callback triggers at the end of training and evaluation batches to record the loss, and at the end of each epoch to evaluate the model and compare it to the best so far. Whether it stops training at the end of an epoch depends on several parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minimum_delta</span></code>: The minimum amount of improvement that a model can have over the previous best model to be considered worthwhile, zero by default, meaning that the training will not stop early unless the performance starts to decrease</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">patience</span></code>: The number of consecutive rounds without improvement before the training is stopped, two by default.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">baseline</span></code>: an optional parameter that is used to compare the model’s score against instead of the best previous model when checking for improvement. This baseline does not get changed over the course of a run.</p></li>
</ul>
</section>
<section id="wiseftcallback">
<h2>WiSEFTCallback<a class="headerlink" href="#wiseftcallback" title="Permalink to this headline">#</a></h2>
<p>WiSE-FT, proposed by Mitchell et al. in <a class="reference external" href="https://arxiv.org/abs/2109.01903">Robust fine-tuning of zero-shot models</a>,
has been proven to be an effective way for fine-tuning models with a strong zero-shot capability,
such as CLIP.</p>
<p>Please refer to <a class="reference internal" href="../../tasks/text-to-image/#wise-ft"><span class="std std-ref">Apply WiSE-FT</span></a> in the CLIP fine-tuning example.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is recommended to use WiSEFTCallback when fine-tuning CLIP.
We can not ensure it works for other category of models, such as ResNet or Bert.</p>
</div>
</section>
</section>

                </article>
            </div>
            <footer>
                
                <div class="related-pages">
                    <a class="next-page" href="../integrate-with-jina/">
                        <div class="page-info">
                            <div class="context">
                                <span>Next</span>
                            </div>
                            <div class="title">Encode Documents</div>
                        </div>
                        <svg class="furo-related-icon">
                            <use href="#svg-arrow-right"></use>
                        </svg>
                    </a>
                    <a class="prev-page" href="../save-model/">
                        <svg class="furo-related-icon">
                            <use href="#svg-arrow-right"></use>
                        </svg>
                        <div class="page-info">
                            <div class="context">
                                <span>Previous</span>
                            </div>
                            
                            <div class="title">Save Artifact</div>
                            
                        </div>
                    </a>
                </div>
                <div class="bottom-of-page">
                    <div class="left-details">
                        <div class="copyright">
                            Copyright &#169; Jina AI Limited. All rights reserved.
                        </div><div class="last-updated">
                            Last updated on Oct 13, 2022</div>
                    </div>
                    <div class="right-details">
                        <div class="social-btns">
                            <a class='social-btn' href="https://github.com/jina-ai/finetuner/" aria-label="GitHub"
                               target="_blank" rel="noreferrer"> <i class="fab fa-github"></i></a>
                            <a class='social-btn' href="https://slack.jina.ai" aria-label="Slack" target="_blank"
                               rel="noreferrer"> <i class="fab fa-slack"></i></a>
                            <a class='social-btn' href="https://youtube.com/c/jina-ai" aria-label="YouTube"
                               target="_blank" rel="noreferrer"> <i class="fab fa-youtube"></i></a>
                            <a class='social-btn' href="https://twitter.com/JinaAI_" aria-label="Twitter"
                               target="_blank" rel="noreferrer"> <i class="fab fa-twitter"></i></a>
                            <a class='social-btn' href="https://www.linkedin.com/company/jinaai/" aria-label="LinkedIn"
                               target="_blank" rel="noreferrer"> <i class="fab fa-linkedin"></i></a>
                        </div>
                    </div>
                </div>
                
            </footer>
        </div>
        <aside class="toc-drawer">
            
            
            <div class="toc-sticky toc-scroll">
                <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
                </div>
                <div class="toc-tree-container">
                    <div class="toc-tree">
                        <ul>
<li><a class="reference internal" href="#">Using Callbacks</a><ul>
<li><a class="reference internal" href="#evaluationcallback">EvaluationCallback</a></li>
<li><a class="reference internal" href="#bestmodelcheckpoint">BestModelCheckpoint</a></li>
<li><a class="reference internal" href="#earlystopping">EarlyStopping</a></li>
<li><a class="reference internal" href="#wiseftcallback">WiSEFTCallback</a></li>
</ul>
</li>
</ul>

                    </div>
                </div>
            </div>
            
            
        </aside>

        <qa-bot
            token="vizI4XaM1li8kQW2kQOiiBjtk02hzBDl0Em8lBjpzAKsjhX_z03mix_i3wKpiA=="
            theme="infer"
            target="_self"
            orientation="bottom-right"
            title="Finetuner"
            description="Task-oriented finetuning for better embeddings on neural search"
            show-tip>
          <template>
            <dl>
             <dt>You can ask questions about our docs. Try:</dt>
             <dd>What is Finetuner?</dd>
             <dd>How does Finetuner Work?</dd>
             <dd>What makes Finetuner unique?</dd>
            </dl>
          </template>
          <template slot="texts">
            <span for="tip">Hi there 👋
         Ask our docs!</span>
            <span for="unknownAnswerText">😵‍💫 I'm sorry but I don't know the answer.</span>
          </template>
        </qa-bot>
</div>
<img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=e0caedb8-a833-4e85-983d-d3394a5f16d2" /><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qabot"></script>
    <script src="../../_static/source-in-links.js"></script>
    </body>
</html>